program test_xrotor
    use, intrinsic :: iso_c_binding, only : c_int, c_bool, c_float
    use api, only : init, set_case, operate, show, get_number_of_stations, get_station_conditions, set_use_compr_corr
    real :: rho, vso, rmu, alt, vel, adv, r_hub, r_tip, r_wake, rake
    real :: geomdata(4, 6), polardata(80, 4)
    logical(c_bool) :: free, duct, wind, use_compr_corr
    real, allocatable :: xi(:), Re(:), M(:)
    real :: res
    integer :: n_stations

    rho = 1.225
    vso = 340.
    rmu = 1.789e-5
    alt = 1.
    vel = 27.
    adv = .15

    r_hub = .06
    r_tip = .83
    r_wake = 0.
    rake = 0.

    geomdata(1, :) = (/0.15, 0.30, 0.45, 0.60, 0.75, 0.90/)
    geomdata(2, :) = (/0.15, 0.16, 0.17, 0.16, 0.13, 0.09/)
    geomdata(3, :) = (/50.0, 30.7, 21.6, 16.5, 13.4, 11.3/)
    geomdata(4, :) = 0.

!    polardata = reshape((/&
!            ! alpha
!            -20.0000, -18.0000, -16.0000, -14.0000, -12.0000, -10.0000,  -8.0000,  -6.0000,  -4.0000,  -2.0000, &
!              2.0000,   4.0000,   6.0000,   8.0000,  10.0000,  12.0000,  14.0000,  16.0000,  18.0000,  20.0000, &
!            ! cl
!             -1.0550,  -1.2246,  -1.2551,  -1.3550,  -1.2452,  -1.0796,  -0.9098,  -0.6940,  -0.4275,  -0.2144, &
!              0.2144,   0.4275,   0.6940,   0.9097,   1.0796,   1.2453,   1.3555,   1.3913,   1.3048,   1.1910, &
!            ! cd
!              0.1450,   0.0891,   0.0622,   0.0256,   0.0193,   0.0151,   0.0122,   0.0098,   0.0073,   0.0058, &
!              0.0058,   0.0073,   0.0098,   0.0122,   0.0151,   0.0193,   0.0256,   0.0412,   0.0819,   0.1332, &
!            ! cm
!              0.0102,  -0.0132,  -0.0370,  -0.0263,  -0.0133,  -0.0054,   0.0040,   0.0041,  -0.0061,  -0.0030, &
!              0.0030,   0.0061,  -0.0041,  -0.0040,   0.0054,   0.0133,   0.0262,   0.0303,   0.0111,  -0.0173/), &
!    (/20, 4/))

    polardata = reshape((/&
    ! alpha
    -20.000,  -19.500,  -19.000,  -18.500,  -18.000,  -17.500,  -17.000,  -16.500,  -16.000,  -15.500, &
    -15.000,  -14.500,  -14.000,  -13.500,  -13.000,  -12.500,  -12.000,  -11.500,  -11.000,  -10.500, &
    -10.000,  -9.500,  -9.000,  -8.500,  -8.000,  -7.500,  -7.000,  -6.500,  -6.000,  -5.500, &
    -5.000,  -4.500,  -4.000,  -3.500,  -3.000,  -2.500,  -2.000,  -1.500,  -1.000,  -0.500, &
    0.500,  1.000,  1.500,  2.000,  2.500,  3.000,  3.500,  4.000,  4.500,  5.000, &
    5.500,  6.000,  6.500,  7.000,  7.500,  8.000,  8.500,  9.000,  9.500,  10.000, &
    10.500,  11.000,  11.500,  12.000,  12.500,  13.000,  13.500,  14.000,  14.500,  15.000, &
    15.500,  16.000,  16.500,  17.000,  17.500,  18.000,  18.500,  19.000,  19.500,  20.000, &
    ! cl
    -0.457,  -0.439,  -0.422,  -0.407,  -0.388,  -0.371,  -0.354,  -0.340,  -0.331,  -0.314, &
    -0.302,  -0.293,  -0.290,  -0.294,  -0.290,  -0.283,  -0.633,  -0.243,  -0.206,  -0.175, &
    -1.298,  -0.208,  -0.293,  -0.203,  -0.165,  -0.085,  -0.041,  0.002,  0.037,  0.091, &
    0.146,  0.202,  0.360,  0.312,  0.368,  0.423,  0.478,  0.532,  0.586,  0.640, &
    0.747,  0.795,  0.849,  0.902,  0.955,  1.009,  1.062,  1.115,  1.168,  1.220, &
    1.271,  1.322,  1.372,  1.421,  1.461,  1.504,  1.544,  1.579,  1.610,  1.632, &
    1.642,  1.638,  1.628,  1.621,  1.616,  1.614,  1.612,  1.605,  1.601,  1.591, &
    1.586,  1.568,  1.563,  1.557,  1.544,  1.538,  1.536,  1.533,  1.529,  1.531, &
    ! cd
    0.226,  0.220,  0.214,  0.207,  0.202,  0.197,  0.191,  0.185,  0.178,  0.173, &
    0.168,  0.163,  0.157,  0.152,  0.148,  0.144,  0.110,  0.125,  0.119,  0.112, &
    0.103,  0.051,  0.047,  0.032,  0.024,  0.047,  0.045,  0.046,  0.014,  0.013, &
    0.012,  0.012,  0.017,  0.010,  0.010,  0.010,  0.009,  0.009,  0.009,  0.009, &
    0.009,  0.008,  0.008,  0.009,  0.009,  0.009,  0.010,  0.010,  0.010,  0.011, &
    0.011,  0.012,  0.012,  0.012,  0.013,  0.013,  0.014,  0.014,  0.015,  0.017, &
    0.019,  0.023,  0.027,  0.031,  0.036,  0.041,  0.047,  0.053,  0.059,  0.066, &
    0.073,  0.082,  0.089,  0.096,  0.105,  0.112,  0.119,  0.126,  0.133,  0.140, &
    ! cm
    -0.013,  -0.016,  -0.021,  -0.025,  -0.027,  -0.030,  -0.033,  -0.036,  -0.040,  -0.041, &
    -0.042,  -0.043,  -0.044,  -0.043,  -0.040,  -0.040,  0.027,  -0.058,  -0.062,  -0.068, &
    0.240,  -0.134,  -0.120,  -0.147,  -0.153,  -0.132,  -0.134,  -0.133,  -0.154,  -0.154, &
    -0.154,  -0.154,  -0.186,  -0.154,  -0.154,  -0.153,  -0.153,  -0.153,  -0.152,  -0.152, &
    -0.151,  -0.150,  -0.149,  -0.149,  -0.149,  -0.148,  -0.148,  -0.147,  -0.147,  -0.147, &
    -0.146,  -0.145,  -0.145,  -0.143,  -0.141,  -0.139,  -0.136,  -0.133,  -0.129,  -0.124, &
    -0.117,  -0.110,  -0.103,  -0.097,  -0.093,  -0.089,  -0.087,  -0.084,  -0.083,  -0.082, &
    -0.081,  -0.081,  -0.081,  -0.082,  -0.083,  -0.084,  -0.085,  -0.087,  -0.088,  -0.091/), &
    (/80, 4/))

    free = .true.
    duct = .false.
    wind = .false.

    use_compr_corr = .false.

    call init()
    call set_case(&
        rho, vso, rmu, alt, vel, adv, &
        r_hub, r_tip, r_wake, rake, &
        2, &
        6, geomdata, &
        1, (/80/), (/0./), polardata, &
        free, duct, wind)
    call set_use_compr_corr(use_compr_corr)
    res = operate(4, 2000.)
    call show()

    n_stations = get_number_of_stations()
    allocate(xi(n_stations))
    allocate(Re(n_stations))
    allocate(M(n_stations))
    call get_station_conditions(n_stations, xi, Re, M)
end program test_xrotor